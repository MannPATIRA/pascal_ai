<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PASCAL Agent</title>
  <style>
    :root { font-family: Segoe UI, Arial, sans-serif; }
    body { margin: 10px; }
    #status { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    #dot { width:10px; height:10px; border-radius:50%; background:#c00; }
    #log { border:1px solid #d0d0d0; height:360px; overflow-y:auto; padding:8px; background:#fff; }
    .bubble { margin:6px 0; padding:8px 10px; border-radius:8px; }
    .u { background:#e8f0ff; }
    .a { background:#f7f7f7; }
    .err { background:#ffe9e9; border:1px solid #f1b3b3; }
    #row { display:flex; gap:8px; margin-top:8px; }
    #msg { flex:1; padding:6px 8px; }
    button { padding:6px 10px; cursor:pointer; }
    #confirmBar { display:none; margin-top:8px; }
    small.hint { display:block; opacity:.7; margin-top:6px; }
    ul, ol, pre { margin:8px 0 0; }
    pre { white-space:pre-wrap; word-break:break-all; background:#fafafa; border:1px solid #eee; padding:6px; }
  </style>
</head>
<body>
  <div id="status">
    <div id="dot" title="Fusion connection"></div>
    <div id="statusText">Not connected to Fusion API</div>
  </div>
  <h3>PASCAL Agent</h3>
  <div id="log"></div>
  <div id="row">
    <input id="msg" type="text" placeholder="Describe what you want to add/change…" />
    <button id="sendBtn">Send</button>
  </div>
  <div id="confirmBar">
    <button id="confirmBtn">Proceed & Execute</button>
  </div>
  <small class="hint">When a plan appears and actions are listed, click “Proceed & Execute”. Typing “yes” only approves the plan.</small>

  <script>
    const log = document.getElementById('log');
    const msg = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const confirmBar = document.getElementById('confirmBar');
    const confirmBtn = document.getElementById('confirmBtn');
    const dot = document.getElementById('dot');
    const statusText = document.getElementById('statusText');

    function addBubble(text, who='a', cls='') {
      if (!text) return;
      const d = document.createElement('div');
      d.className = `bubble ${who} ${cls}`;
      d.textContent = text;
      log.appendChild(d);
      log.scrollTop = log.scrollHeight;
    }
    function addList(items, ordered=false) {
      if (!items || !items.length) return;
      const container = document.createElement('div');
      container.className = 'bubble a';
      const list = ordered ? document.createElement('ol') : document.createElement('ul');
      for (const it of items) {
        const li = document.createElement('li');
        li.textContent = it;
        list.appendChild(li);
      }
      container.appendChild(list);
      log.appendChild(container);
      log.scrollTop = log.scrollHeight;
    }
    function addActionsPreview(actions) {
      if (!actions || !actions.length) return;
      const wrap = document.createElement('div');
      wrap.className = 'bubble a';
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(actions, null, 2);
      wrap.appendChild(pre);
      log.appendChild(wrap);
      log.scrollTop = log.scrollHeight;
    }

    function fusionConnected() {
      const ok = (typeof window.adsk !== 'undefined') &&
                 adsk && typeof adsk.fusionSendData === 'function';
      dot.style.background = ok ? '#2ecc71' : '#c00';
      statusText.textContent = ok ? 'Connected to Fusion API' : 'Not connected to Fusion API';
      return ok;
    }

    function send() {
      const t = msg.value.trim();
      if (!t) return;
      addBubble(t, 'u');
      msg.value = '';

      const payload = { event: 'user_message', user_message: t };
      const data = JSON.stringify(payload);
      if (!fusionConnected()) {
        addBubble('Send failed: Fusion API not available in this palette.', 'a', 'err');
        return;
      }
      try {
        addBubble('↗ sending: ' + data, 'a');
        adsk.fusionSendData('agent_event', data);
      } catch (e) {
        addBubble('Send exception: ' + e.toString(), 'a', 'err');
      }
    }

    function confirmExec() {
      const payload = { event: 'confirm_execute', user_message: 'OK to proceed' };
      const data = JSON.stringify(payload);
      if (!fusionConnected()) {
        addBubble('Confirm failed: Fusion API not available in this palette.', 'a', 'err');
        return;
      }
      try {
        addBubble('↗ sending confirm: ' + data, 'a');
        adsk.fusionSendData('agent_event', data);
      } catch (e) {
        addBubble('Confirm exception: ' + e.toString(), 'a', 'err');
      }
    }

    sendBtn.addEventListener('click', send);
    msg.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
    confirmBtn.addEventListener('click', confirmExec);

    // Fusion -> HTML
    window.fusionJavaScriptHandler = {
      handle: function(action, data) {
        try {
          if (action !== 'agent_reply') return 'IGNORED';
          const o = JSON.parse(data);

          if (o.assistant_message) addBubble(o.assistant_message, 'a');
          if (Array.isArray(o.questions) && o.questions.length) addList(o.questions, false);
          if (Array.isArray(o.plan) && o.plan.length) addList(o.plan, true);
          if (Array.isArray(o.actions) && o.actions.length) addActionsPreview(o.actions);

          const hasActions = Array.isArray(o.actions) && o.actions.length > 0;
          confirmBar.style.display = (o.status === 'ready_to_execute' || hasActions) ? 'block' : 'none';
          return 'OK';
        } catch (e) {
          addBubble('HTML handler exception: ' + e.toString(), 'a', 'err');
          return 'Exception: ' + e.toString();
        }
      }
    };

    // Initial connection indicator
    fusionConnected();
  </script>
</body>
</html>
